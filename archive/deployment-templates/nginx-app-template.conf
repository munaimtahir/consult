# Template for adding a new app to nginx/default.conf
# Copy this template and replace:
#   - APP_NAME with your app name (e.g., app2, app3)
#   - APP_PATH with your app path (e.g., /app2, /app3)
#   - BACKEND_PORT with your backend port (default: 8000)
#   - FRONTEND_PORT with your frontend port (default: 80)

# Add rate limiting zones at the top (after existing rate limiting zones):
limit_req_zone $binary_remote_addr zone=APP_NAME_api_limit:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=APP_NAME_ws_limit:10m rate=10r/m;

# Add upstream definitions (after consult app upstreams):
upstream APP_NAME_backend {
    server APP_NAME_backend:BACKEND_PORT max_fails=3 fail_timeout=30s;
}

upstream APP_NAME_frontend {
    server APP_NAME_frontend:FRONTEND_PORT max_fails=3 fail_timeout=30s;
}

# Add location blocks (before the error pages section in the main server block):

    # APP_NAME App - Health check endpoint
    location APP_PATH/api/health/ {
        proxy_pass http://APP_NAME_backend;
        proxy_set_header Host $host;
        access_log off;
    }

    # APP_NAME App - API endpoints
    location APP_PATH/api/ {
        limit_req zone=APP_NAME_api_limit burst=20 nodelay;
        
        proxy_pass http://APP_NAME_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
    }

    # APP_NAME App - WebSocket endpoints (if needed)
    location APP_PATH/ws/ {
        limit_req zone=APP_NAME_ws_limit burst=5 nodelay;
        
        proxy_pass http://APP_NAME_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_read_timeout 86400s;
        proxy_buffering off;
    }

    # APP_NAME App - Static files
    location APP_PATH/static/ {
        alias /app/APP_NAME/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # APP_NAME App - Media files
    location APP_PATH/media/ {
        alias /app/APP_NAME/media/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # APP_NAME App - Frontend
    location APP_PATH/ {
        proxy_pass http://APP_NAME_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
    }

